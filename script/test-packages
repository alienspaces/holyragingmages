#!/usr/bin/env bash

# "docker" or "local"
export APP_DB_SERVICE=docker
if [ -n "$1" ]; then
    export APP_DB_SERVICE=$1
    shift
fi

dir="common"
for f in "$dir"/*; do
    echo "Testing => $f"
    cd $f
    if [ -f "go.mod" ]; then
        go test -cover -count 1 ./ || exit $?
    fi
    cd -
done

dir="common/type"
for f in "$dir"/*; do
    echo "Testing => $f"
    cd $f
    if [ -f "go.mod" ]; then
        go test -cover -count 1 ./ || exit $?
    fi
    cd -
done

dir="service"
for f in "$dir"/*; do
    echo "Testing => $f"
    cd $f
    export APP_HOME=$(pwd)
    echo "Testing => APP_HOME - ${APP_HOME}"

    if [ $APP_DB_SERVICE = "ci" ]; then
        if [ -f ".env.ci" ]; then
            echo "Testing => Sourcing service .env.ci"
            source .env.ci
        fi
    else
        if [ -f ".env.development" ]; then
            echo "Testing => Sourcing service .env.development"
            source .env.development
        fi
    fi
    if [ -f "go.mod" ]; then
        go test -cover -count 1 ./... || exit $?
    fi
    cd -
done
